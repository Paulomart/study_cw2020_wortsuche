package cool.paul.fh.wortsuche.client;

import java.util.Observable;

import javax.jms.ConnectionFactory;
import javax.jms.JMSContext;
import javax.jms.Message;
import javax.jms.MessageListener;
import javax.jms.Queue;
import javax.jms.Topic;
import javax.naming.Context;
import javax.naming.InitialContext;
import javax.naming.NamingException;

import cool.paul.fh.wortsuche.common.beans.GameInstanceRemote;
import cool.paul.fh.wortsuche.common.beans.GameManagementRemote;
import cool.paul.fh.wortsuche.common.beans.PlayerSessionRemote;
import cool.paul.fh.wortsuche.common.entity.Game;
import cool.paul.fh.wortsuche.common.entity.Player;

public class ServiceHandlerImpl extends Observable implements MessageListener {

	private Context ctx;

	private GameManagementRemote gameManagement;
	private GameInstanceRemote gameInstance;
	private PlayerSessionRemote playerSession;

	private JMSContext jmsContext;
	private Topic observerTopic;
	private Queue customerRequestQueue;

	public ServiceHandlerImpl() {
		initializeBeans();
		initializeJMSConnections();
	}

	private void initializeBeans() {
		try {
			ctx = new InitialContext();

			gameManagement = (GameManagementRemote) ctx.lookup(
					"java:global/Wortsuche-ear/Wortsuche-ejb/GameManagementBean!cool.paul.fh.wortsuche.common.beans.GameManagementRemote");
			gameInstance = (GameInstanceRemote) ctx.lookup(
					"java:global/Wortsuche-ear/Wortsuche-ejb/GameInstanceBean!cool.paul.fh.wortsuche.common.beans.GameInstanceRemote");
			playerSession = (PlayerSessionRemote) ctx.lookup(
					"java:global/Wortsuche-ear/Wortsuche-ejb/PlayerSessionBean!cool.paul.fh.wortsuche.common.beans.PlayerSessionRemote");
		} catch (NamingException e) {
			throw new RuntimeException(e);
		}
	}

	private void initializeJMSConnections() {
		try {
			// Common
			ConnectionFactory connectionFactory = (ConnectionFactory) ctx
					.lookup("java:comp/DefaultJMSConnectionFactory");
			jmsContext = connectionFactory.createContext();

			// Topic
			observerTopic = (Topic) ctx.lookup("java:global/jms/GameStateUpdates");
			jmsContext.createConsumer(observerTopic).setMessageListener(this);

			// Queue
//			customerRequestQueue = (Queue) ctx.lookup("java:global/jms/CustomerRequestQueue");
		} catch (Exception e) {
			throw new RuntimeException(e);
		}
	}

	@Override
	public void onMessage(Message arg0) {
		// TODO Auto-generated method stub
		setChanged();
		notifyObservers(arg0);

	}

	public Player join(String name) {
		return playerSession.join(name);
	}

	public void startGame() {
		playerSession.startGame();
	}

	public Game getGame() {
		return gameInstance.getGame();
	}

	public boolean selectWord(int x1, int y1, int x2, int y2) {
		return gameInstance.selectWord(playerSession.getPlayer(), x1, y1, x2, y2);
	}
}
