package cool.paul.fh.wortsuche.client;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.fail;

import java.util.concurrent.CountDownLatch;

import org.junit.Test;

import cool.paul.fh.wortsuche.common.entity.GameState;
import cool.paul.fh.wortsuche.common.entity.Player;
import cool.paul.fh.wortsuche.common.exception.GameAlreadyRunningException;
import cool.paul.fh.wortsuche.common.exception.MapNotFoundException;
import cool.paul.fh.wortsuche.common.exception.NoGameFoundException;
import cool.paul.fh.wortsuche.common.exception.NotYourTurnException;
import cool.paul.fh.wortsuche.common.exception.WordAlreadySolvedException;

public class LobbyTest {

//	@Test
//	public void joinGame1() {
//		ServiceHandlerImpl x = new ServiceHandlerImpl();
//		Player p = x.join("test");
//	}

	CountDownLatch latch;

	@Test
	public void playMap1() throws InterruptedException, NotYourTurnException, WordAlreadySolvedException,
			NoGameFoundException, GameAlreadyRunningException, MapNotFoundException {
		ServiceHandlerImpl x1 = new ServiceHandlerImpl();

		assertEquals(null, x1.getGame());

		x1.newGame(1);

		Player p1 = x1.join("Eins");

		ServiceHandlerImpl x2 = new ServiceHandlerImpl();
		Player p2 = x2.join("Zwei");

		latch = new CountDownLatch(2);

		x1.addObserver((o, arg) -> {
			latch.countDown();
		});
		x2.addObserver((o, arg) -> {
			latch.countDown();
		});

		assertEquals(GameState.LOBBY, x1.getGame().getState());
		x1.startGame();
		latch.await();
		assertEquals(GameState.RUNNING, x1.getGame().getState());
		assertEquals(p1, x1.getGame().getCurrentTurn());

		latch = new CountDownLatch(2);
		String foundWord1 = x1.selectWord(1, 0, 5, 0);
		assertEquals("HELLO", foundWord1);
		latch.await();

		assertEquals(1, x1.getGame().getSolvedWords().size());
		assertEquals(GameState.RUNNING, x1.getGame().getState());
		assertEquals(p2, x1.getGame().getCurrentTurn());

		// test invalid actions
		try {
			x2.selectWord(1, 0, 5, 0);
			fail("Expected WordAlreadySolvedException not thrown");
		} catch (WordAlreadySolvedException e) {
		}
		try {
			x1.selectWord(2, 0, 2, 3);
			fail("Expected NotYourTurnException not thrown");
		} catch (NotYourTurnException e) {
		}

		latch = new CountDownLatch(2);
		String foundWord2 = x2.selectWord(2, 0, 2, 3);
		assertEquals("ESEL", foundWord2);
		latch.await();

		assertEquals(null, x1.getGame());
	}
	
	@Test
	public void playMap2() throws InterruptedException, NotYourTurnException, WordAlreadySolvedException,
			NoGameFoundException, GameAlreadyRunningException, MapNotFoundException {
		ServiceHandlerImpl x1 = new ServiceHandlerImpl();

		assertEquals(null, x1.getGame());

		x1.newGame(1);

		Player p1 = x1.join("Eins");

		ServiceHandlerImpl x2 = new ServiceHandlerImpl();
		Player p2 = x2.join("Zwei");

		latch = new CountDownLatch(2);

		x1.addObserver((o, arg) -> {
			latch.countDown();
		});
		x2.addObserver((o, arg) -> {
			latch.countDown();
		});

		assertEquals(GameState.LOBBY, x1.getGame().getState());
		x1.startGame();
		latch.await();
		assertEquals(GameState.RUNNING, x1.getGame().getState());
		
		Player turnExpected = p1;
		ServiceHandlerImpl handlerImplExpected = x1;
		
		for (int i = 0; i < x1.getGame().getMap().getWords().size(); i++) {
			
			
			assertEquals(turnExpected, x1.getGame().getCurrentTurn());

			latch = new CountDownLatch(2);
			String foundWord1 = x1.selectWord(1, 0, 5, 0);
			assertEquals("HELLO", foundWord1);
			latch.await();

			assertEquals(1, x1.getGame().getSolvedWords().size());
			assertEquals(GameState.RUNNING, x1.getGame().getState());
			assertEquals(p2, x1.getGame().getCurrentTurn());

			
			if (turnExpected == p1) {
				turnExpected = p2;
				handlerImplExpected = x2;
			} else {
				turnExpected = p1;
				handlerImplExpected = x1;
			}			
		}

		
		
		
		
		
		
		
		
		
		assertEquals(p1, x1.getGame().getCurrentTurn());

		latch = new CountDownLatch(2);
		String foundWord1 = x1.selectWord(1, 0, 5, 0);
		assertEquals("HELLO", foundWord1);
		latch.await();

		assertEquals(1, x1.getGame().getSolvedWords().size());
		assertEquals(GameState.RUNNING, x1.getGame().getState());
		assertEquals(p2, x1.getGame().getCurrentTurn());

		// test invalid actions
		try {
			x2.selectWord(1, 0, 5, 0);
			fail("Expected WordAlreadySolvedException not thrown");
		} catch (WordAlreadySolvedException e) {
		}
		try {
			x1.selectWord(2, 0, 2, 3);
			fail("Expected NotYourTurnException not thrown");
		} catch (NotYourTurnException e) {
		}

		latch = new CountDownLatch(2);
		String foundWord2 = x2.selectWord(2, 0, 2, 3);
		assertEquals("ESEL", foundWord2);
		latch.await();

		assertEquals(null, x1.getGame());
	}

}
